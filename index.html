<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendario de Objetivos</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #1a1a1a;
            color: #e0e0e0;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 20px;
        }

        .header h1 {
            color: #32b8c6;
            font-size: 28px;
            cursor: pointer;
        }

        .month-nav {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .settings-btn {
            background: #32b8c6;
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s;
            position: relative;
        }

        .settings-btn:hover {
            background: #2da5b1;
            transform: translateY(-2px);
        }

        .settings-menu {
            display: none;
            position: absolute;
            top: 50px;
            right: 0;
            background: #2a2a2a;
            border: 2px solid #404040;
            border-radius: 12px;
            padding: 10px;
            min-width: 200px;
            z-index: 100;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
        }

        .settings-menu.active {
            display: block;
        }

        .settings-menu-item {
            padding: 12px 16px;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
        }

        .settings-menu-item:hover {
            background: #404040;
            transform: translateX(4px);
        }

        .month-nav button {
            background: #32b8c6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }

        .month-nav button:hover {
            background: #2da5b1;
            transform: translateY(-2px);
        }

        .month-nav span {
            font-size: 20px;
            font-weight: 600;
            min-width: 200px;
            text-align: center;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #2a2a2a 0%, #1f1f1f 100%);
            border: 1px solid #404040;
            border-radius: 12px;
            padding: 24px;
            transition: all 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 16px rgba(50, 184, 198, 0.2);
        }

        .stat-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .stat-card-header span {
            font-size: 14px;
            color: #999;
            font-weight: 500;
        }

        .stat-icon {
            font-size: 24px;
        }

        .stat-value {
            font-size: 36px;
            font-weight: 700;
            background: linear-gradient(135deg, #32b8c6 0%, #4ade80 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: 30px;
        }

        .calendar-section {
            background: #2a2a2a;
            border: 1px solid #404040;
            border-radius: 16px;
            padding: 24px;
        }

        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
            margin-top: 20px;
        }

        .calendar-header {
            font-size: 13px;
            font-weight: 700;
            text-align: center;
            padding: 12px;
            color: #32b8c6;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 2px solid #404040;
            border-radius: 12px;
            cursor: pointer;
            background: linear-gradient(135deg, #2a2a2a 0%, #252525 100%);
            position: relative;
            transition: all 0.3s ease;
        }

        .calendar-day:hover {
            border-color: #32b8c6;
            transform: translateY(-4px);
            box-shadow: 0 6px 20px rgba(50, 184, 198, 0.3);
        }

        .calendar-day.empty {
            cursor: default;
            opacity: 0.3;
            background: transparent;
        }

        .calendar-day.empty:hover {
            border-color: #404040;
            transform: none;
            box-shadow: none;
        }

        .calendar-day.today {
            font-weight: 700;
        }

        .calendar-day.selected {
            background: linear-gradient(135deg, #1e4a4f 0%, #2a5a5f 100%);
            border-color: #4ade80;
        }

        .calendar-day.has-tasks {
            background: linear-gradient(135deg, #1e4a4f 0%, #2a5a5f 100%);
            border-color: #32b8c6;
        }

        .day-number {
            font-size: 18px;
            font-weight: 700;
        }

        .day-indicator {
            width: 8px;
            height: 8px;
            background: #32b8c6;
            border-radius: 50%;
            margin-top: 6px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .objectives-section {
            background: #2a2a2a;
            border: 1px solid #404040;
            border-radius: 16px;
            padding: 24px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-header h2 {
            font-size: 20px;
            color: #e0e0e0;
        }

        .btn-add {
            background: linear-gradient(135deg, #32b8c6 0%, #2da5b1 100%);
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-add:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(50, 184, 198, 0.4);
        }

        .objective-item {
            background: linear-gradient(135deg, #1a1a1a 0%, #151515 100%);
            border: 1px solid #404040;
            border-radius: 12px;
            padding: 18px;
            margin-bottom: 14px;
            transition: all 0.3s;
        }

        .objective-item:hover {
            border-color: #32b8c6;
            transform: translateX(4px);
        }

        .objective-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .objective-title {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 4px;
            color: #32b8c6;
        }

        .objective-desc {
            font-size: 13px;
            color: #999;
        }

        .objective-actions {
            display: flex;
            gap: 8px;
        }

        .btn-icon {
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 18px;
            padding: 6px;
            transition: all 0.3s;
        }

        .btn-icon:hover {
            transform: scale(1.2);
        }

        .progress-bar {
            height: 10px;
            background: #404040;
            border-radius: 10px;
            overflow: hidden;
            margin: 12px 0;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #32b8c6 0%, #4ade80 100%);
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 0 10px rgba(50, 184, 198, 0.6);
        }

        .progress-text {
            font-size: 15px;
            color: #32b8c6;
            font-weight: 700;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(135deg, #2a2a2a 0%, #252525 100%);
            border: 1px solid #404040;
            border-radius: 16px;
            padding: 28px;
            max-width: 550px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
        }

        .modal-content::-webkit-scrollbar {
            width: 10px;
        }

        .modal-content::-webkit-scrollbar-track {
            background: #1a1a1a;
            border-radius: 10px;
        }

        .modal-content::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #32b8c6 0%, #2da5b1 100%);
            border-radius: 10px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .modal-header h3 {
            font-size: 22px;
            color: #32b8c6;
        }

        .btn-close {
            background: transparent;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #999;
            transition: all 0.3s;
        }

        .btn-close:hover {
            color: #32b8c6;
            transform: rotate(90deg);
        }

        .form-group {
            margin-bottom: 18px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #32b8c6;
            font-size: 14px;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 14px;
            border: 2px solid #404040;
            border-radius: 10px;
            background: #1a1a1a;
            color: #e0e0e0;
            font-family: inherit;
            font-size: 16px;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #32b8c6;
            box-shadow: 0 0 0 3px rgba(50, 184, 198, 0.2);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 90px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #32b8c6 0%, #2da5b1 100%);
            color: white;
            border: none;
            padding: 14px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 700;
            width: 100%;
            font-size: 16px;
            transition: all 0.3s;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(50, 184, 198, 0.5);
        }

        .task-list {
            margin-top: 24px;
            max-height: 400px;
            overflow-y: auto;
        }

        .task-list::-webkit-scrollbar {
            width: 8px;
        }

        .task-list::-webkit-scrollbar-track {
            background: #1a1a1a;
            border-radius: 8px;
        }

        .task-list::-webkit-scrollbar-thumb {
            background: #32b8c6;
            border-radius: 8px;
        }

        .task-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px;
            background: #1a1a1a;
            border: 2px solid #404040;
            border-radius: 10px;
            margin-bottom: 10px;
            transition: all 0.3s;
        }

        .task-item:hover {
            border-color: #32b8c6;
            transform: translateX(4px);
        }

        .task-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .task-item.completed {
            opacity: 0.6;
        }

        .task-item.completed .task-text {
            text-decoration: line-through;
        }

        .task-text {
            flex: 1;
            font-size: 15px;
        }

        .task-badge {
            font-size: 11px;
            padding: 4px 10px;
            background: linear-gradient(135deg, #32b8c6 0%, #2da5b1 100%);
            color: white;
            border-radius: 12px;
            font-weight: 600;
        }

        .delete-btn {
            background: linear-gradient(135deg, #ff5459 0%, #e04449 100%);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .delete-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(255, 84, 89, 0.4);
        }

        .chart-container {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 30px 20px;
            position: relative;
        }

        #progressChart {
            filter: drop-shadow(0 10px 20px rgba(50, 184, 198, 0.3));
        }

        .chart-legend {
            margin-top: 20px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 8px;
            background: #1a1a1a;
            transition: all 0.3s;
        }

        .legend-item:hover {
            transform: translateX(4px);
            background: #252525;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }

        .legend-text {
            flex: 1;
            font-size: 14px;
        }

        .legend-value {
            font-weight: 700;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .calendar-day {
                font-size: 14px;
            }

            .day-number {
                font-size: 16px;
            }
        }

        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 22px;
            }

            .calendar {
                gap: 6px;
            }

            .calendar-day {
                min-height: 50px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 id="calendarTitle">üìä Calendario de Objetivos</h1>
            <div class="month-nav">
                <button onclick="changeMonth(-1)">‚Üê Anterior</button>
                <span id="currentMonth"></span>
                <button onclick="changeMonth(1)">Siguiente ‚Üí</button>
                <div style="position: relative;">
                    <button class="settings-btn" onclick="toggleSettingsMenu()">‚öôÔ∏è</button>
                    <div class="settings-menu" id="settingsMenu">
                        <div class="settings-menu-item" onclick="openRenameModal()">
                            ‚úèÔ∏è Renombrar calendario
                        </div>
                        <div class="settings-menu-item" onclick="openDownloadModal()">
                            üì• Descargar datos
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-card-header">
                    <span>Objetivos Activos</span>
                    <span class="stat-icon">üéØ</span>
                </div>
                <div class="stat-value" id="activeGoals">0</div>
            </div>

            <div class="stat-card">
                <div class="stat-card-header">
                    <span>Completados</span>
                    <span class="stat-icon">‚úÖ</span>
                </div>
                <div class="stat-value" id="completedGoals">0</div>
            </div>

            <div class="stat-card">
                <div class="stat-card-header">
                    <span>Racha Actual</span>
                    <span class="stat-icon">üî•</span>
                </div>
                <div class="stat-value" id="currentStreak">0</div>
            </div>

            <div class="stat-card">
                <div class="stat-card-header">
                    <span>Promedio Mensual</span>
                    <span class="stat-icon">üìà</span>
                </div>
                <div class="stat-value" id="monthlyAverage">0%</div>
            </div>
        </div>

        <div class="main-content">
            <div class="calendar-section">
                <div class="calendar">
                    <div class="calendar-header">Dom</div>
                    <div class="calendar-header">Lun</div>
                    <div class="calendar-header">Mar</div>
                    <div class="calendar-header">Mi√©</div>
                    <div class="calendar-header">Jue</div>
                    <div class="calendar-header">Vie</div>
                    <div class="calendar-header">S√°b</div>
                </div>
                <div class="calendar" id="calendarGrid"></div>
                
                <div class="objectives-section" style="margin-top: 20px;">
                    <div class="section-header">
                        <h2 id="dayViewTitle">Tareas del D√≠a</h2>
                        <button class="btn-add" onclick="openDayModal(selectedDay || new Date().getDate())">+ Agregar Tarea</button>
                    </div>
                    <div id="dayViewTaskList" style="max-height: 300px; overflow-y: auto;">
                        <p style="text-align: center; color: #999; padding: 20px;">Selecciona un d√≠a del calendario</p>
                    </div>
                </div>
            </div>

            <div class="sidebar">
                <div class="objectives-section">
                    <div class="section-header">
                        <h2>Objetivos</h2>
                        <button class="btn-add" onclick="openObjectiveModal()">+ Agregar</button>
                    </div>
                    <div id="objectivesList"></div>
                    <button class="btn-primary" onclick="resetAllData()" style="margin-top: 20px; background: linear-gradient(135deg, #ff5459 0%, #e04449 100%);">Reset</button>
                </div>
                
                <div class="objectives-section">
                    <div class="section-header">
                        <h2>Progreso General</h2>
                    </div>
                    <div class="chart-container">
                        <canvas id="progressChart" width="280" height="280"></canvas>
                    </div>
                    <div class="chart-legend" id="chartLegend"></div>
                </div>

                <div class="objectives-section">
                    <div class="section-header">
                        <h2>Tareas Completadas</h2>
                    </div>
                    <div id="completedTasksList" style="max-height: 300px; overflow-y: auto;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para objetivos -->
    <div class="modal" id="objectiveModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="objectiveModalTitle">Nuevo Objetivo</h3>
                <button class="btn-close" onclick="closeObjectiveModal()">√ó</button>
            </div>
            <input type="hidden" id="editingObjectiveId">
            <div class="form-group">
                <label>T√≠tulo</label>
                <input type="text" id="objectiveTitle" placeholder="Ej: Aumentar ventas">
            </div>
            <div class="form-group">
                <label>Descripci√≥n</label>
                <textarea id="objectiveDesc" placeholder="Describe tu objetivo..."></textarea>
            </div>
            <div class="form-group">
                <label>Progreso Actual (%)</label>
                <input type="number" id="objectiveCurrent" min="0" max="100" value="0">
            </div>
            <button class="btn-primary" onclick="saveObjective()">Guardar Objetivo</button>
        </div>
    </div>

    <!-- Modal para renombrar calendario -->
    <div class="modal" id="renameModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Renombrar Calendario</h3>
                <button class="btn-close" onclick="closeRenameModal()">√ó</button>
            </div>
            <div class="form-group">
                <label>Nuevo nombre</label>
                <input type="text" id="newCalendarName" placeholder="Ej: Mi Calendario Personal">
            </div>
            <button class="btn-primary" onclick="saveCalendarName()">Guardar Nombre</button>
        </div>
    </div>

    <!-- Modal para descargar datos -->
    <div class="modal" id="downloadModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Descargar Datos</h3>
                <button class="btn-close" onclick="closeDownloadModal()">√ó</button>
            </div>
            <div class="form-group">
                <label>Selecciona el mes</label>
                <select id="downloadMonthSelect">
                    <option value="">Seleccionar mes...</option>
                </select>
            </div>
            <button class="btn-primary" onclick="executeDownload()">Descargar PDF</button>
        </div>
    </div>

    <!-- Modal para tareas del d√≠a -->
    <div class="modal" id="dayModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Tareas del D√≠a</h3>
                <button class="btn-close" onclick="closeDayModal()">√ó</button>
            </div>
            <div class="form-group">
                <label>Nueva Tarea</label>
                <input type="text" id="newTask" placeholder="Escribe una tarea...">
            </div>
            <div class="form-group">
                <label>Hora (opcional)</label>
                <input type="time" id="taskTime">
            </div>
            <div class="form-group">
                <label>Fecha inicio</label>
                <input type="date" id="taskStartDate">
            </div>
            <div class="form-group">
                <label>Fecha fin</label>
                <input type="date" id="taskEndDate">
            </div>
            <div class="form-group">
                <label>Vincular a objetivo</label>
                <select id="linkedObjective">
                    <option value="">Sin vincular</option>
                </select>
            </div>
            <div class="form-group">
                <label>Peso de la tarea (%)</label>
                <input type="number" id="taskWeight" min="1" max="100" value="10">
            </div>
            <button class="btn-primary" onclick="addTask()">Agregar Tarea</button>
            <div class="task-list" id="taskList"></div>
        </div>
    </div>

    <script>
        let currentDate = new Date();
        let selectedDay = null;
        let objectives = [];
        let dayData = {};
        let monthlyData = {};
        let calendarName = 'Calendario de Objetivos';

        function getMonthKey() {
            return `${currentDate.getFullYear()}-${currentDate.getMonth()}`;
        }

        function loadData() {
            const savedMonthlyData = localStorage.getItem('monthlyData');
            
            if (savedMonthlyData) {
                monthlyData = JSON.parse(savedMonthlyData);
            }

            const savedName = localStorage.getItem('calendarName');
            if (savedName) {
                calendarName = savedName;
                document.getElementById('calendarTitle').textContent = `üìä ${calendarName}`;
            }

            const monthKey = getMonthKey();
            if (monthlyData[monthKey]) {
                objectives = monthlyData[monthKey].objectives || [];
                dayData = monthlyData[monthKey].dayData || {};
            } else {
                objectives = [];
                dayData = {};
            }
        }

        function saveData() {
            const monthKey = getMonthKey();
            monthlyData[monthKey] = {
                objectives: objectives,
                dayData: dayData
            };
            localStorage.setItem('monthlyData', JSON.stringify(monthlyData));
        }

        function init() {
            loadData();
            updateMonthDisplay();
            renderCalendar();
            renderObjectives();
            updateStats();
            drawProgressChart();
            renderCompletedTasks();
        }

        function changeMonth(delta) {
            currentDate.setMonth(currentDate.getMonth() + delta);
            loadData();
            updateMonthDisplay();
            renderCalendar();
            renderObjectives();
            updateStats();
            drawProgressChart();
            renderCompletedTasks();
        }

        function updateMonthDisplay() {
            const months = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                            'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            document.getElementById('currentMonth').textContent = 
                `${months[currentDate.getMonth()]} ${currentDate.getFullYear()}`;
        }

        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const today = new Date();
            
            grid.innerHTML = '';
            
            for (let i = 0; i < firstDay; i++) {
                const emptyDiv = document.createElement('div');
                emptyDiv.className = 'calendar-day empty';
                grid.appendChild(emptyDiv);
            }
            
            for (let day = 1; day <= daysInMonth; day++) {
                const dayDiv = document.createElement('div');
                dayDiv.className = 'calendar-day';
                
                const dateKey = `${year}-${month}-${day}`;
                const hasTasks = dayData[dateKey] && dayData[dateKey].length > 0;
                
                if (hasTasks) {
                    dayDiv.classList.add('has-tasks');
                }
                
                if (today.getDate() === day && today.getMonth() === month && today.getFullYear() === year) {
                    dayDiv.classList.add('today');
                }
                
                dayDiv.innerHTML = `
                    <span class="day-number">${day}</span>
                    ${hasTasks ? '<div class="day-indicator"></div>' : ''}
                `;
                
                dayDiv.onclick = () => {
                    document.querySelectorAll('.calendar-day').forEach(d => d.classList.remove('selected'));
                    dayDiv.classList.add('selected');
                    selectedDay = day;
                    updateDayView(day);
                };
                grid.appendChild(dayDiv);
            }
        }

        function openDayModal(day) {
            selectedDay = day;
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            document.getElementById('modalTitle').textContent = `Tareas - ${day} de ${getMonthName()}`;
            document.getElementById('dayModal').classList.add('active');
            
            updateDayView(day);
            
            const select = document.getElementById('linkedObjective');
            select.innerHTML = '<option value="">Sin vincular</option>';
            objectives.forEach(obj => {
                select.innerHTML += `<option value="${obj.id}">${obj.title} (${obj.current}%)</option>`;
            });
            
            const monthStr = String(month + 1).padStart(2, '0');
            const dayStr = String(day).padStart(2, '0');
            const dateString = `${year}-${monthStr}-${dayStr}`;
            
            document.getElementById('taskStartDate').value = dateString;
            document.getElementById('taskEndDate').value = dateString;
            
            renderTasks();
        }

        function closeDayModal() {
            document.getElementById('dayModal').classList.remove('active');
            document.getElementById('newTask').value = '';
            document.getElementById('taskTime').value = '';
            document.getElementById('taskWeight').value = '10';
        }

        function getMonthName() {
            const months = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                            'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            return months[currentDate.getMonth()];
        }

        function addTask() {
            const taskText = document.getElementById('newTask').value.trim();
            if (!taskText) {
                alert('Por favor escribe una tarea');
                return;
            }

            const taskTime = document.getElementById('taskTime').value;
            const linkedObjId = document.getElementById('linkedObjective').value;
            const taskWeight = parseInt(document.getElementById('taskWeight').value) || 10;
            const startDateStr = document.getElementById('taskStartDate').value;
            const endDateStr = document.getElementById('taskEndDate').value;

            if (!startDateStr || !endDateStr) {
                alert('Por favor selecciona las fechas');
                return;
            }

            const startDate = new Date(startDateStr + 'T00:00:00');
            const endDate = new Date(endDateStr + 'T00:00:00');

            if (endDate < startDate) {
                alert('La fecha fin debe ser posterior o igual a la fecha inicio');
                return;
            }

            const baseId = Date.now();
            let daysAffected = 0;

            const currentLoop = new Date(startDate);
            while (currentLoop <= endDate) {
                const year = currentLoop.getFullYear();
                const month = currentLoop.getMonth();
                const day = currentLoop.getDate();
                const dateKey = `${year}-${month}-${day}`;

                if (!dayData[dateKey]) {
                    dayData[dateKey] = [];
                }

                const task = {
                    id: baseId + daysAffected,
                    baseId: baseId,
                    text: taskText,
                    time: taskTime,
                    linkedObjectiveId: linkedObjId ? parseInt(linkedObjId) : null,
                    weight: taskWeight,
                    completed: false,
                    isIndependent: true
                };

                dayData[dateKey].push(task);
                daysAffected++;

                currentLoop.setDate(currentLoop.getDate() + 1);
            }

            if (daysAffected > 1) {
                alert(`Tarea agregada a ${daysAffected} d√≠as`);
            }

            document.getElementById('newTask').value = '';
            document.getElementById('taskTime').value = '';
            document.getElementById('taskWeight').value = '10';

            saveData();
            renderTasks();
            renderCalendar();
        }

        function renderTasks() {
            const dateKey = `${currentDate.getFullYear()}-${currentDate.getMonth()}-${selectedDay}`;
            const tasks = dayData[dateKey] || [];
            const container = document.getElementById('taskList');

            if (tasks.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">No hay tareas</p>';
                return;
            }

            tasks.sort((a, b) => {
                if (!a.time && !b.time) return 0;
                if (!a.time) return 1;
                if (!b.time) return -1;
                return a.time.localeCompare(b.time);
            });

            container.innerHTML = tasks.map(task => {
                const objective = task.linkedObjectiveId ? objectives.find(o => o.id == task.linkedObjectiveId) : null;

                return `
                    <div class="task-item ${task.completed ? 'completed' : ''}">
                        <input type="checkbox" ${task.completed ? 'checked' : ''} 
                               onchange="toggleTask(${task.id})">
                        <div class="task-text">
                            <strong>${task.text}</strong>
                            ${task.time ? `<br><small style="color: #999;">‚è∞ ${task.time}</small>` : ''}
                            ${objective ? `<br><small style="color: #32b8c6;">üéØ ${objective.title} (${task.weight}%)</small>` : ''}
                        </div>
                        <button class="delete-btn" onclick="deleteTask(${task.id})">üóëÔ∏è</button>
                    </div>
                `;
            }).join('');
        }

        function toggleTask(taskId) {
            const dateKey = `${currentDate.getFullYear()}-${currentDate.getMonth()}-${selectedDay}`;
            const task = dayData[dateKey].find(t => t.id === taskId);

            if (task) {
                task.completed = !task.completed;

                if (task.linkedObjectiveId) {
                    updateObjectiveProgress(task.linkedObjectiveId);
                }

                saveData();
                renderTasks();
                renderCalendar();
                renderObjectives();
                updateStats();
                drawProgressChart();
                renderCompletedTasks();
            }
        }

        function deleteTask(taskId) {
            if (!confirm('¬øEliminar esta tarea?')) return;

            const dateKey = `${currentDate.getFullYear()}-${currentDate.getMonth()}-${selectedDay}`;
            const task = dayData[dateKey].find(t => t.id === taskId);
            const linkedObjId = task ? task.linkedObjectiveId : null;

            dayData[dateKey] = dayData[dateKey].filter(t => t.id !== taskId);

            if (linkedObjId) {
                updateObjectiveProgress(linkedObjId);
            }

            saveData();
            renderTasks();
            renderCalendar();
            renderObjectives();
            updateStats();
            drawProgressChart();
            renderCompletedTasks();
        }

        function updateObjectiveProgress(objectiveId) {
            const objective = objectives.find(o => o.id == objectiveId);
            if (!objective) return;

            let totalCompletedWeight = 0;

            Object.keys(dayData).forEach(dateKey => {
                const dayTasks = dayData[dateKey].filter(t => t.linkedObjectiveId == objectiveId);
                
                dayTasks.forEach(task => {
                    if (task.completed) {
                        totalCompletedWeight += task.weight;
                    }
                });
            });

            objective.current = Math.min(100, totalCompletedWeight);
            saveData();
        }

        function renderObjectives() {
            const container = document.getElementById('objectivesList');

            if (objectives.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">No hay objetivos</p>';
                return;
            }

            container.innerHTML = objectives.map(obj => `
                <div class="objective-item">
                    <div class="objective-header">
                        <div>
                            <div class="objective-title">${obj.title}</div>
                            <div class="objective-desc">${obj.description}</div>
                        </div>
                        <div class="objective-actions">
                            <button class="btn-icon" onclick="editObjective(${obj.id})" title="Editar">‚úèÔ∏è</button>
                            <button class="btn-icon" onclick="deleteObjective(${obj.id})" title="Eliminar">üóëÔ∏è</button>
                        </div>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${obj.current}%"></div>
                    </div>
                    <div class="progress-text">${obj.current}%</div>
                </div>
            `).join('');
        }

        function openObjectiveModal() {
            document.getElementById('objectiveModalTitle').textContent = 'Nuevo Objetivo';
            document.getElementById('editingObjectiveId').value = '';
            document.getElementById('objectiveTitle').value = '';
            document.getElementById('objectiveDesc').value = '';
            document.getElementById('objectiveCurrent').value = '0';
            document.getElementById('objectiveModal').classList.add('active');
        }

        function closeObjectiveModal() {
            document.getElementById('objectiveModal').classList.remove('active');
        }

        function editObjective(id) {
            const objective = objectives.find(o => o.id == id);
            if (!objective) return;

            document.getElementById('objectiveModalTitle').textContent = 'Editar Objetivo';
            document.getElementById('editingObjectiveId').value = id;
            document.getElementById('objectiveTitle').value = objective.title;
            document.getElementById('objectiveDesc').value = objective.description;
            document.getElementById('objectiveCurrent').value = objective.current;
            document.getElementById('objectiveModal').classList.add('active');
        }

        function saveObjective() {
            const title = document.getElementById('objectiveTitle').value.trim();
            const description = document.getElementById('objectiveDesc').value.trim();
            const current = parseInt(document.getElementById('objectiveCurrent').value) || 0;
            const editingId = document.getElementById('editingObjectiveId').value;

            if (!title) {
                alert('Por favor ingresa un t√≠tulo');
                return;
            }

            if (editingId) {
                const objective = objectives.find(o => o.id == editingId);
                if (objective) {
                    objective.title = title;
                    objective.description = description;
                    objective.current = Math.min(100, Math.max(0, current));
                }
            } else {
                objectives.push({
                    id: Date.now(),
                    title,
                    description,
                    current: Math.min(100, Math.max(0, current))
                });
            }

            saveData();
            closeObjectiveModal();
            renderObjectives();
            updateStats();
            drawProgressChart();
        }

        function deleteObjective(id) {
            if (!confirm('¬øEliminar este objetivo? Las tareas vinculadas perder√°n la vinculaci√≥n.')) return;

            objectives = objectives.filter(o => o.id != id);
            saveData();
            renderObjectives();
            updateStats();
            drawProgressChart();
        }

        function updateStats() {
            const active = objectives.filter(o => o.current < 100).length;
            const completed = objectives.filter(o => o.current >= 100).length;

            document.getElementById('activeGoals').textContent = active;
            document.getElementById('completedGoals').textContent = completed;

            let streak = 0;
            const today = new Date();
            for (let i = 0; i < 30; i++) {
                const checkDate = new Date(today);
                checkDate.setDate(checkDate.getDate() - i);
                const dateKey = `${checkDate.getFullYear()}-${checkDate.getMonth()}-${checkDate.getDate()}`;
                const dayTasks = dayData[dateKey];

                if (dayTasks && dayTasks.some(t => t.completed)) {
                    streak++;
                } else if (i > 0) {
                    break;
                }
            }

            document.getElementById('currentStreak').textContent = streak;

            const totalProgress = objectives.reduce((sum, obj) => sum + obj.current, 0);
            const average = objectives.length > 0 ? Math.round(totalProgress / objectives.length) : 0;
            document.getElementById('monthlyAverage').textContent = average + '%';
        }

        function drawProgressChart() {
            const canvas = document.getElementById('progressChart');
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            const padding = 40;
            const chartWidth = width - padding * 2;
            const chartHeight = height - padding * 2;

            ctx.clearRect(0, 0, width, height);

            if (objectives.length === 0) {
                ctx.fillStyle = '#999';
                ctx.font = 'bold 16px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('No hay objetivos', width / 2, height / 2);
                document.getElementById('chartLegend').innerHTML = '';
                return;
            }

            const colors = ['#32b8c6', '#4ade80', '#fb923c', '#a78bfa', '#f472b6', '#fbbf24', '#f87171', '#60a5fa'];
            const totalProgress = objectives.reduce((sum, obj) => sum + obj.current, 0);
            const overallPercentage = Math.round(totalProgress / objectives.length);

            // Dibujar ejes
            ctx.strokeStyle = '#404040';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, height - padding);
            ctx.lineTo(width - padding, height - padding);
            ctx.stroke();

            // Dibujar l√≠neas horizontales
            for (let i = 0; i <= 5; i++) {
                const y = padding + (chartHeight / 5) * i;
                const value = 100 - (i * 20);
                
                ctx.strokeStyle = '#333';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(width - padding, y);
                ctx.stroke();

                ctx.fillStyle = '#999';
                ctx.font = '12px sans-serif';
                ctx.textAlign = 'right';
                ctx.fillText(value + '%', padding - 10, y + 4);
            }

            // Dibujar barras
            const barWidth = chartWidth / objectives.length * 0.7;
            const barSpacing = chartWidth / objectives.length;

            objectives.forEach((obj, index) => {
                const x = padding + barSpacing * index + (barSpacing - barWidth) / 2;
                const barHeight = (obj.current / 100) * chartHeight;
                const y = height - padding - barHeight;

                // Gradiente para cada barra
                const gradient = ctx.createLinearGradient(x, y, x, height - padding);
                gradient.addColorStop(0, colors[index % colors.length]);
                gradient.addColorStop(1, adjustBrightness(colors[index % colors.length], -30));

                // Dibujar barra
                ctx.fillStyle = gradient;
                ctx.fillRect(x, y, barWidth, barHeight);

                // Borde de barra
                ctx.strokeStyle = colors[index % colors.length];
                ctx.lineWidth = 2;
                ctx.strokeRect(x, y, barWidth, barHeight);

                // Porcentaje encima de la barra
                ctx.fillStyle = colors[index % colors.length];
                ctx.font = 'bold 14px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(obj.current + '%', x + barWidth / 2, y - 10);

                // Nombre del objetivo debajo
                ctx.fillStyle = '#999';
                ctx.font = '11px sans-serif';
                ctx.save();
                ctx.translate(x + barWidth / 2, height - padding + 15);
                ctx.rotate(-Math.PI / 4);
                ctx.textAlign = 'right';
                const maxLength = 15;
                const shortTitle = obj.title.length > maxLength ? obj.title.substring(0, maxLength) + '...' : obj.title;
                ctx.fillText(shortTitle, 0, 0);
                ctx.restore();
            });

            // Promedio general
            ctx.fillStyle = '#32b8c6';
            ctx.font = 'bold 18px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText(`Promedio: ${overallPercentage}%`, width / 2, 20);

            const legendHtml = objectives.map((obj, index) => `
                <div class="legend-item">
                    <div class="legend-color" style="background: ${colors[index % colors.length]};"></div>
                    <span class="legend-text">${obj.title}</span>
                    <span class="legend-value" style="color: ${colors[index % colors.length]};">${obj.current}%</span>
                </div>
            `).join('');

            document.getElementById('chartLegend').innerHTML = legendHtml;
        }

        function adjustBrightness(color, percent) {
            const num = parseInt(color.replace("#",""), 16);
            const amt = Math.round(2.55 * percent);
            const R = (num >> 16) + amt;
            const G = (num >> 8 & 0x00FF) + amt;
            const B = (num & 0x0000FF) + amt;
            return "#" + (0x1000000 + (R<255?R<1?0:R:255)*0x10000 + (G<255?G<1?0:G:255)*0x100 + (B<255?B<1?0:B:255)).toString(16).slice(1);
        }

        function resetAllData() {
            monthlyData = {};
            objectives = [];
            dayData = {};
            localStorage.removeItem('monthlyData');

            renderCalendar();
            renderObjectives();
            updateStats();
            drawProgressChart();
            renderCompletedTasks();
        }

        function renderCompletedTasks() {
            const container = document.getElementById('completedTasksList');
            const completedTasks = [];
            
            const currentYear = currentDate.getFullYear();
            const currentMonth = currentDate.getMonth();

            Object.keys(dayData).forEach(dateKey => {
                const [year, month, day] = dateKey.split('-').map(Number);
                
                if (year !== currentYear || month !== currentMonth) {
                    return;
                }
                
                const tasks = dayData[dateKey].filter(t => t.completed);

                tasks.forEach(task => {
                    completedTasks.push({
                        ...task,
                        dateKey,
                        year: dateYear,
                        month: dateMonth,
                        day
                    });
                });
            });

            completedTasks.sort((a, b) => {
                const dateA = new Date(a.year, a.month, a.day);
                const dateB = new Date(b.year, b.month, b.day);
                if (dateB - dateA !== 0) return dateB - dateA;
                if (a.time && b.time) return b.time.localeCompare(a.time);
                return 0;
            });

            if (completedTasks.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">No hay tareas completadas</p>';
                return;
            }

            const months = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];

            container.innerHTML = completedTasks.slice(0, 20).map(task => {
                const monthName = months[task.month];
                const dateStr = `${task.day} ${monthName} ${task.year}`;
                const timeStr = task.time || 'Sin hora';

                return `
                    <div class="task-item" style="margin-bottom: 10px;">
                        <div class="task-text">
                            <strong>${task.text}</strong>
                            <br><small style="color: #999;">üìÖ ${dateStr} - ‚è∞ ${timeStr}</small>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateDayView(day) {
            const dateKey = `${currentDate.getFullYear()}-${currentDate.getMonth()}-${day}`;
            const tasks = dayData[dateKey] || [];
            const container = document.getElementById('dayViewTaskList');
            
            document.getElementById('dayViewTitle').textContent = `Tareas - ${day} de ${getMonthName()}`;

            if (tasks.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">No hay tareas para este d√≠a</p>';
                return;
            }

            tasks.sort((a, b) => {
                if (!a.time && !b.time) return 0;
                if (!a.time) return 1;
                if (!b.time) return -1;
                return a.time.localeCompare(b.time);
            });

            container.innerHTML = tasks.map(task => {
                const objective = task.linkedObjectiveId ? objectives.find(o => o.id == task.linkedObjectiveId) : null;

                return `
                    <div class="task-item ${task.completed ? 'completed' : ''}">
                        <input type="checkbox" ${task.completed ? 'checked' : ''} 
                               onchange="toggleTaskInView(${task.id}, ${day})">
                        <div class="task-text">
                            <strong>${task.text}</strong>
                            ${task.time ? `<br><small style="color: #999;">‚è∞ ${task.time}</small>` : ''}
                            ${objective ? `<br><small style="color: #32b8c6;">üéØ ${objective.title} (${task.weight}%)</small>` : ''}
                        </div>
                        <button class="delete-btn" onclick="deleteTaskInView(${task.id}, ${day})">üóëÔ∏è</button>
                    </div>
                `;
            }).join('');
        }

        function toggleTaskInView(taskId, day) {
            const dateKey = `${currentDate.getFullYear()}-${currentDate.getMonth()}-${day}`;
            const task = dayData[dateKey].find(t => t.id === taskId);

            if (task) {
                task.completed = !task.completed;

                if (task.linkedObjectiveId) {
                    updateObjectiveProgress(task.linkedObjectiveId);
                }

                saveData();
                updateDayView(day);
                renderCalendar();
                renderObjectives();
                updateStats();
                drawProgressChart();
                renderCompletedTasks();
            }
        }

        function deleteTaskInView(taskId, day) {
            if (!confirm('¬øEliminar esta tarea?')) return;

            const dateKey = `${currentDate.getFullYear()}-${currentDate.getMonth()}-${day}`;
            const task = dayData[dateKey].find(t => t.id === taskId);
            const linkedObjId = task ? task.linkedObjectiveId : null;

            dayData[dateKey] = dayData[dateKey].filter(t => t.id !== taskId);

            if (linkedObjId) {
                updateObjectiveProgress(linkedObjId);
            }

            saveData();
            updateDayView(day);
            renderCalendar();
            renderObjectives();
            updateStats();
            drawProgressChart();
            renderCompletedTasks();
        }

        function toggleSettingsMenu() {
            const menu = document.getElementById('settingsMenu');
            menu.classList.toggle('active');
        }

        function openRenameModal() {
            document.getElementById('newCalendarName').value = calendarName;
            document.getElementById('renameModal').classList.add('active');
            toggleSettingsMenu();
        }

        function closeRenameModal() {
            document.getElementById('renameModal').classList.remove('active');
        }

        function saveCalendarName() {
            const newName = document.getElementById('newCalendarName').value.trim();
            if (!newName) {
                alert('Por favor ingresa un nombre');
                return;
            }

            calendarName = newName;
            localStorage.setItem('calendarName', calendarName);
            document.getElementById('calendarTitle').textContent = `üìä ${calendarName}`;
            closeRenameModal();
        }

        function openDownloadModal() {
            toggleSettingsMenu();
            
            const select = document.getElementById('downloadMonthSelect');
            select.innerHTML = '<option value="">Seleccionar mes...</option>';
            
            const months = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                            'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            
            Object.keys(monthlyData).forEach(monthKey => {
                const [year, month] = monthKey.split('-').map(Number);
                const monthName = months[month];
                const option = document.createElement('option');
                option.value = monthKey;
                option.textContent = `${monthName} ${year}`;
                select.appendChild(option);
            });
            
            document.getElementById('downloadModal').classList.add('active');
        }

        function closeDownloadModal() {
            document.getElementById('downloadModal').classList.remove('active');
        }

        function executeDownload() {
            const selectedMonth = document.getElementById('downloadMonthSelect').value;
            
            if (!selectedMonth) {
                alert('Por favor selecciona un mes');
                return;
            }
            
            const [year, month] = selectedMonth.split('-').map(Number);
            const monthData = monthlyData[selectedMonth];
            
            if (!monthData) {
                alert('No hay datos para este mes');
                return;
            }
            
            downloadPDF(year, month, monthData);
            closeDownloadModal();
        }

        function downloadPDF(year, month, monthData) {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF();
            
            const objectives = monthData.objectives || [];
            const dayData = monthData.dayData || {};
            
            // Encabezado con fondo
            pdf.setFillColor(50, 184, 198);
            pdf.rect(0, 0, 210, 35, 'F');
            
            // T√≠tulo
            pdf.setFontSize(24);
            pdf.setTextColor(255, 255, 255);
            pdf.setFont(undefined, 'bold');
            pdf.text(calendarName, 20, 18);
            
            // Fecha
            pdf.setFontSize(14);
            const months = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                            'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            pdf.text(`${months[month]} ${year}`, 20, 28);
            
            let yPos = 50;
            
            // An√°lisis de objetivos
            pdf.setFontSize(18);
            pdf.setTextColor(50, 184, 198);
            pdf.setFont(undefined, 'bold');
            pdf.text('An√°lisis del Mes', 20, yPos);
            yPos += 10;
            
            if (objectives.length > 0) {
                // Calcular estad√≠sticas
                const sortedObjectives = [...objectives].sort((a, b) => b.current - a.current);
                const mostCompleted = sortedObjectives[0];
                const leastCompleted = sortedObjectives[sortedObjectives.length - 1];
                const averageProgress = Math.round(objectives.reduce((sum, obj) => sum + obj.current, 0) / objectives.length);
                
                // Contar tareas por objetivo
                const taskCounts = {};
                objectives.forEach(obj => {
                    taskCounts[obj.id] = 0;
                });
                
                Object.keys(dayData).forEach(dateKey => {
                    const [dateYear, dateMonth] = dateKey.split('-').map(Number);
                    if (dateYear === year && dateMonth === month) {
                        dayData[dateKey].forEach(task => {
                            if (task.completed && task.linkedObjectiveId && taskCounts[task.linkedObjectiveId] !== undefined) {
                                taskCounts[task.linkedObjectiveId]++;
                            }
                        });
                    }
                });
                
                // Bullet points con an√°lisis
                pdf.setFontSize(11);
                pdf.setTextColor(50, 50, 50);
                pdf.setFont(undefined, 'normal');
                
                const bulletPoints = [
                    `‚Ä¢ Objetivo m√°s logrado: ${mostCompleted.title} con ${mostCompleted.current}% de progreso`,
                    `  ${taskCounts[mostCompleted.id] || 0} tareas completadas`,
                    ``,
                    `‚Ä¢ Objetivo con menor progreso: ${leastCompleted.title} con ${leastCompleted.current}%`,
                    `  ${taskCounts[leastCompleted.id] || 0} tareas completadas`,
                    ``,
                    `‚Ä¢ Progreso promedio general: ${averageProgress}%`,
                    ``,
                    `‚Ä¢ Total de objetivos activos: ${objectives.length}`,
                    `‚Ä¢ Objetivos completados (100%): ${objectives.filter(o => o.current >= 100).length}`
                ];
                
                bulletPoints.forEach(point => {
                    pdf.text(point, 25, yPos);
                    yPos += 6;
                });
                
                yPos += 10;
            }
            
            // Secci√≥n: Objetivos
            pdf.setFontSize(18);
            pdf.setTextColor(50, 184, 198);
            pdf.setFont(undefined, 'bold');
            pdf.text('Objetivos del Mes', 20, yPos);
            yPos += 10;
            
            if (objectives.length === 0) {
                pdf.setFontSize(11);
                pdf.setTextColor(100, 100, 100);
                pdf.setFont(undefined, 'normal');
                pdf.text('No hay objetivos registrados', 25, yPos);
                yPos += 15;
            } else {
                // Tabla de objetivos
                const objectivesData = objectives.map(obj => [
                    obj.title,
                    obj.description.substring(0, 40) + (obj.description.length > 40 ? '...' : ''),
                    `${obj.current}%`
                ]);
                
                pdf.autoTable({
                    startY: yPos,
                    head: [['Objetivo', 'Descripci√≥n', 'Progreso']],
                    body: objectivesData,
                    theme: 'grid',
                    headStyles: {
                        fillColor: [50, 184, 198],
                        textColor: [255, 255, 255],
                        fontStyle: 'bold',
                        fontSize: 11
                    },
                    bodyStyles: {
                        fontSize: 10,
                        textColor: [50, 50, 50]
                    },
                    alternateRowStyles: {
                        fillColor: [245, 245, 245]
                    },
                    columnStyles: {
                        0: { cellWidth: 50 },
                        1: { cellWidth: 90 },
                        2: { cellWidth: 30, halign: 'center' }
                    },
                    margin: { left: 20, right: 20 }
                });
                
                yPos = pdf.lastAutoTable.finalY + 15;
            }
            
            // Gr√°fica de progreso
            if (objectives.length > 0 && yPos < 200) {
                pdf.setFontSize(18);
                pdf.setTextColor(50, 184, 198);
                pdf.setFont(undefined, 'bold');
                pdf.text('Gr√°fica de Progreso', 20, yPos);
                yPos += 10;
                
                const canvas = document.getElementById('progressChart');
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = 800;
                tempCanvas.height = 800;
                const tempCtx = tempCanvas.getContext('2d');
                tempCtx.drawImage(canvas, 0, 0, 800, 800);
                const imgData = tempCanvas.toDataURL('image/png', 1.0);
                pdf.addImage(imgData, 'PNG', 70, yPos, 65, 65);
                yPos += 75;
            }
            
            // Nueva p√°gina para tareas completadas
            if (yPos > 220 || objectives.length > 0) {
                pdf.addPage();
                yPos = 20;
            }
            
            // Secci√≥n: Tareas Completadas
            pdf.setFontSize(18);
            pdf.setTextColor(50, 184, 198);
            pdf.setFont(undefined, 'bold');
            pdf.text('Tareas Completadas', 20, yPos);
            yPos += 10;
            
            const completedTasks = [];

            Object.keys(dayData).forEach(dateKey => {
                const [dateYear, dateMonth, day] = dateKey.split('-').map(Number);
                
                if (dateYear !== year || dateMonth !== month) {
                    return;
                }
                
                const tasks = dayData[dateKey].filter(t => t.completed);

                tasks.forEach(task => {
                    completedTasks.push({
                        ...task,
                        dateKey,
                        year,
                        month,
                        day
                    });
                });
            });

            completedTasks.sort((a, b) => {
                const dateA = new Date(a.year, a.month, a.day);
                const dateB = new Date(b.year, b.month, b.day);
                if (dateB - dateA !== 0) return dateB - dateA;
                if (a.time && b.time) return b.time.localeCompare(a.time);
                return 0;
            });
            
            if (completedTasks.length === 0) {
                pdf.setFontSize(11);
                pdf.setTextColor(100, 100, 100);
                pdf.setFont(undefined, 'normal');
                pdf.text('No hay tareas completadas', 25, yPos);
            } else {
                const displayTasks = completedTasks.slice(0, 20);
                const monthsShort = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
                
                const tasksData = displayTasks.map(task => {
                    const monthName = monthsShort[task.month];
                    const dateStr = `${task.day} ${monthName}`;
                    const timeStr = task.time || 'Sin hora';
                    
                    return [
                        task.text,
                        dateStr,
                        timeStr
                    ];
                });
                
                pdf.autoTable({
                    startY: yPos,
                    head: [['Tarea', 'Fecha', 'Hora']],
                    body: tasksData,
                    theme: 'striped',
                    headStyles: {
                        fillColor: [50, 184, 198],
                        textColor: [255, 255, 255],
                        fontStyle: 'bold',
                        fontSize: 11
                    },
                    bodyStyles: {
                        fontSize: 10,
                        textColor: [50, 50, 50]
                    },
                    alternateRowStyles: {
                        fillColor: [245, 245, 245]
                    },
                    columnStyles: {
                        0: { cellWidth: 110 },
                        1: { cellWidth: 35, halign: 'center' },
                        2: { cellWidth: 35, halign: 'center' }
                    },
                    margin: { left: 20, right: 20 }
                });
            }
            
            // Footer
            const pageCount = pdf.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                pdf.setPage(i);
                pdf.setFontSize(9);
                pdf.setTextColor(150, 150, 150);
                pdf.setFont(undefined, 'normal');
                pdf.text(`P√°gina ${i} de ${pageCount}`, 105, 290, { align: 'center' });
                pdf.text(`Generado: ${new Date().toLocaleDateString()}`, 190, 290, { align: 'right' });
            }
            
            // Descargar
            pdf.save(`${calendarName.replace(/[^a-z0-9]/gi, '_')}_${year}_${month + 1}.pdf`);
        }

        // Cerrar men√∫ de configuraci√≥n al hacer click fuera
        document.addEventListener('click', function(event) {
            const settingsBtn = event.target.closest('.settings-btn');
            const settingsMenu = document.getElementById('settingsMenu');
            
            if (!settingsBtn && !event.target.closest('.settings-menu')) {
                settingsMenu.classList.remove('active');
            }
        });

        window.addEventListener('DOMContentLoaded', init);
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
</body>
</html>
